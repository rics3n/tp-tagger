"use strict";angular.module("tpTagger",[]).directive("tpTagger",["$timeout","$filter","$log",function(e,t,s){return{restrict:"AE",templateUrl:"tp_tagger.tpl.html",scope:{options:"="},controller:["$scope",function(e){e.hasFocus=!1,e.isSuggestionsVisible=!1,e.suggestions=[],e.searchTag="",e.searching=!1,e.selectedSuggestionIndex=-1,e.uniqueError=!1,e.maxTagLengthError=!1,e.hasError=!1;var n=function(t,s){e[t]=s,e.hasError=s};e.addTag=function(t){t.length>e.options.maxTagLength?(s.debug("tag too long"),n("maxTagLengthError",!0),e.searchTag=""):e.options.uniqueTags&&-1!==e.selectedLowerTags.indexOf(t.toLowerCase())?(s.debug("tag not unique"),n("uniqueError",!0),e.searchTag=""):""===t?s.debug("tag empty"):(e.selectedTags.push(t),e.selectedLowerTags.push(t.toLowerCase()),e.searchTag="",e.options.addFunction&&e.options.addFunction(t))},e.deleteTag=function(t){var s=angular.copy(e.selectedTags[t]);e.selectedTags.splice(t,1),e.selectedLowerTags.splice(t,1),e.options.deleteFunction&&e.options.deleteFunction(s)},e.search=function(t){e.searching||(e.searching=!0,t(e.selectedTags).then(function(){s.debug("finshed searching"),e.searching=!1},function(t){s.error(t),e.searching=!1}))},e.isActive=function(t){return t===e.selectedSuggestionIndex},e.selectActive=function(t){e.selectedSuggestionIndex=t},e.changeInput=function(){e.searchTag.length>e.options.minChar?(e.suggestions=t("filter")(e.dictionary,e.searchTag)||[],e.suggestions=e.suggestions.slice(0,e.options.maxResults),e.changeSuggestionVisible(e.suggestions.length>=1?!0:!1)):e.isSuggestionsVisible&&e.changeSuggestionVisible(!1),e.resetErrors()},e.changeSuggestionVisible=function(t){t?e.isSuggestionsVisible=!0:(e.selectedSuggestionIndex=-1,e.selectedSuggestion=void 0,e.isSuggestionsVisible=!1)},e.resetErrors=function(){e.hasError&&(s.debug("reset errors"),e.uniqueError=!1,e.hasError=!1)}}],link:function(e){e.options=e.options||{},e.options.minChar=e.options.minChar||1,e.options.maxResults=e.options.maxResults||10,e.options.maxTagLength=e.options.maxTagLength||50,e.selectedTags=e.options.selectedTags||[],e.selectedLowerTags=[];for(var t=0;t<e.selectedTags.length;t++)e.selectedLowerTags.push(e.selectedTags[t].toLowerCase());e.dictionary=e.options.dictionary||[],e.options.uniqueTags=e.options.uniqueTags||!0,e.options.errors=e.options.errors||{notUniqueTag:"The tag which you tried to add is not unique. You may only add a Tag once.",maxTagLength:"The tag which you tried to add is too long. Only "+e.options.maxTagLength+" characters are allowed."}}}}]).directive("tpTaggerInput",["$log","$window",function(e,t){var s=[8,9,13,17,27,188],n=[38,40];return{restrict:"A",require:"^ngModel",link:function(i,g){var o={};g.bind("blur",function(){i.searchTag.length>0&&i.selectedSuggestionIndex<0?i.addTag(i.searchTag):i.selectedSuggestionIndex>=0?i.addTag(i.suggestions[i.selectedSuggestionIndex].name):i.resetErrors(),i.changeSuggestionVisible(!1)}),g.bind("keydown",function(g){if(i.isSuggestionsVisible&&-1!==n.indexOf(g.which)||-1!==s.indexOf(g.which)){if(8===g.which&&""!==i.searchTag)return void(o={})}else if(!o[17]||83!==g.which)return void(o={});g||(g=t.event),o[g.which]="keydown"===g.type,o[9]||g.preventDefault(),o[13]||o[9]||o[188]?(i.selectedSuggestion?(i.addTag(i.selectedSuggestion.name),g.preventDefault()):i.searchTag.length>0?(i.addTag(i.searchTag),g.preventDefault()):i.options.searchFunction&&!o[9]&&(i.search(i.options.searchFunction),g.preventDefault()),i.changeSuggestionVisible(!1),i.$digest(),o={}):o[17]&&o[83]?(e.info("Search for tags"),g.preventDefault(),i.options.searchFunction&&i.search(i.options.searchFunction),o={}):o[27]?(i.changeSuggestionVisible(!1),i.$digest(),o={}):o[40]?(i.isSuggestionsVisible&&(i.selectedSuggestionIndex=i.selectedSuggestionIndex<i.suggestions.length-1&&i.selectedSuggestionIndex>=0?i.selectedSuggestionIndex+1:0,i.selectedSuggestion=i.suggestions[i.selectedSuggestionIndex],i.$digest()),o={}):o[8]&&""===i.searchTag&&i.selectedTags.length>0?(i.deleteTag(i.selectedTags.length-1),o={},i.$digest()):o[38]?(i.isSuggestionsVisible&&(i.selectedSuggestionIndex=i.selectedSuggestionIndex>0?i.selectedSuggestionIndex-1:i.suggestions.length-1,i.selectedSuggestion=i.suggestions[i.selectedSuggestionIndex],i.$digest()),o={}):o[17]||(o={})})}}}]).directive("tpTaggerPopup",function(){return{restrict:"A",replace:!0,templateUrl:"tp_tagger_popup.tpl.html"}}).directive("tpFocus",["$timeout","$parse",function(e,t){return{link:function(s,n,i){var g=t(i.tpFocus);s.$watch(g,function(t){t===!0&&e(function(){n[0].focus()})}),n.bind("blur",function(){s.$apply(g.assign(s,!1))})}}}]),angular.module("tpTagger").run(["$templateCache",function(e){e.put("tp_tagger.tpl.html",'<div ng-click="setFocus = true"><div class="tp-tagger-error-texts" ng-show="hasError"><span ng-show="uniqueError">{{options.errors.notUniqueTag}}</span> <span ng-show="maxTagLengthError">{{options.errors.maxTagLength}}</span></div><div class="tp-tagger"><div class="tp-tags-wrapper"><div class="tp-tags"><span class="tp-tag" ng-repeat="tag in selectedTags track by $index">{{ tag }}<span class="delete" ng-click="deleteTag($index)"><i class="fa fa-times"></i></span></span> <input tp-tagger-input="" ng-change="changeInput()" type="text" class="input input-text tp-tag-input" placeholder="{{options.placeholderText}}" ng-focus="hasFocus = true" ng-blur="hasFocus = false" tp-focus="setFocus" ng-model="searchTag" autocomplete="off"></div></div><div class="tp-btn-wrapper"><button class="btn btn-primary btn-add" type="button" ng-click="addTag(searchTag)" ng-if="options.addBtnActive"><i class="fa fa-plus"></i></button> <button class="btn btn-primary btn-search" type="button" ng-click="search(options.searchFunction)" ng-if="options.searchFunction" ng-disabled="searching"><span ng-hide="searching"><i class="fa fa-search"></i></span> <span ng-show="searching"><i class="fa fa-spinner fa-spin"></i></span></button></div></div><div tp-tagger-popup=""></div></div>'),e.put("tp_tagger_popup.tpl.html",'<div class="tp-tagger-suggestions" ng-show="isSuggestionsVisible"><ul><li ng-repeat="suggestion in suggestions track by $index" ng-class="{active: isActive($index)}" ng-mouseenter="selectActive($index)"><div class="tp-text">{{suggestion.name}}</div><div class="tp-break" ng-if="!$last"></div></li></ul></div>')}]);